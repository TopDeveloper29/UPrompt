# [Back](https://github.com/TopDeveloper29/UPrompt/blob/Prod/README.md) | How to create an extension for UPrompt

Here you will learn how you can do something with UPrompt and not just create a UI but take action on the system, because without that, it's basically just a browser displaying an HTML page that is generated by an XML file.

## Powershell
The Powershell Extension is really powerful and simple to put in place, but it is more limited when it comes to interacting with the application. Basically, you create a file as normal, but you don't want to put your code directly in it; you should put it in a function.

### How it works in the back-end
When you specify the setting "Powershell," that will start a new process of Powershell that will load:
`Application Path\Resources\Code\PsHandler.ps1`. This will set up the correct environment for running the script, and it takes one argument: the path of your script file. It will keep the code of the file in the environment:
```
$scriptContent = Get-Content -Path "$path" -Raw;
$this.ScriptBlock = [ScriptBlock]::Create($scriptContent);
```
Then it will fall into an infinite loop of waiting for input from UPrompt:
```
Invoke-Expression $this.ScriptBlock.ToString()
do {
    $ReadInput = Read-Host -Prompt "PowershellHandler waiting for input function or command";
    [string]$Variables = Get-Content "$PSScriptRoot`\Variables.ps1" -Force;
    Invoke-Expression -Command "$Variables";
    $this.Run($ReadInput);
    Start-Sleep -Milliseconds 1000;
}
while ($true)
```
### How to use it
First, you create your script file. For example, I will do a simple script to test if a directory exists. If yes, delete it:

> For this example the script file will be call MyScript.ps1 and be save next to UPrompt.exe directory.
```powershell
function TestAndDelete([string]$Path)
{
    if(Test-Path "$Path" -PathType Container)
    { Remove-Item -Path "$Path" -Recurse -Force; }
}
```
So you load it using:

```xml
<Setting Name="Powershell" Value="{AppPathWindows}MyScript.ps1" Id="2024"/>
```

Then you can add any kind of view item and related action. Here I will use a button.

```xml
<ViewAction Type="Button" Action="RunPowershell" Argument='2024,TestAndDelete -Path "C:\TEMP";'>
Run this script
</ViewAction>
```
So here, that will send input to the Powershell process that is running PsHandler, and then when it receives the input, it will try to run it. In this case, it will run the function you just created, `TestAndDelete`, and pass an argument to it: `-Path "C:\TEMP"`

> Note: You can also directly run Powershell code in this action. For example, if you write `Write-Host "{DEVICE}"` instead of the `TestAndDelete` function, it will directly run the code and then return the device name as output.

Every time you run a Powershell function or code, it will try to catch some output to place in the result variable of the action.

You can load DLLs and may use some classes like you would do in a C# extension, but things may break because they are not designed to run in an external process. Here's an example of how you can do it:
```
$assembly = [Reflection.Assembly]::LoadFrom("C:\Users\beah\source\repos\TopDeveloper29\UPrompt\bin\Debug\UPrompt.Core.dll");
$UCommon = $assembly.GetType("UPrompt.Core.UCommon");
$UParser = $assembly.GetType("UPrompt.Core.UParser");
$UHandler = $assembly.GetType("UPrompt.Core.UHandler");
$USettings = $assembly.GetType("UPrompt.Core.USettings");
$UPrompt = $assembly.GetType("UPrompt.Core.Prompt");
$UHandler::RunAction("ShowVariable","MyVariable","TEST_PS")
```

## C# (DLL)
The C# Extension is a bit more complicated to put in place, but it provides closer control of UPrompt. For example, UDesigner 100% works with an extension.

### Get started
1. Open Visual Studio and create a new project of type Class Library (.NET Framework)
2. Name your project as you want.
3. Add a reference to the **UPrompt.Core.dll** (Right-click on References and then browse)
4. Add `using UPrompt.Core;` to the top of your main .cs file.

So far, your main .cs file should look like this:

```csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using UPrompt.Core;

namespace DEMO
{
    public class Class1
    {
    }
}
```

5. Add the `static` attribute to your main class. In this example, `Class1`.
6. Add your first method that you want to be static.
7. Start doing your stuff and calling UPrompt methods.

Here's how the example should look when you're done:

```csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using UPrompt.Core;

namespace DEMO
{
    public class Class1
    {
        public static void MyFirstMethod(string value)
        {
        	Console.WriteLine($"Extension method called with this value: {value} here some data that came directly form UPrompt: {USettings.Application_Name}");
        }
    }
}
```

### How to use it in UPrompt
First, you want to load the extension using this setting:

```xml
<Setting Name="Extension" Value="{AppPathWindows}DEMO.dll,DEMO.Class1" Id="2025"/>
```
Then, you want to run the method using an action. For example, a button:

```xml
<ViewAction Type="Button" Action="RunMethod" Argument='2025,MyFirstMethod("And my name is {USER}")'>
Run Method Now
</ViewAction>
```

And now you're done. You can create your own code and create behavior using the C# language, until you want to interact back with UPrompt and the UI.

### Class Overview
Here is the list of classes you can find and a description of the properties and methods you can use in your extension.

#### UCommon
This contains all shared data that may be used by multiple classes, such as variables, a reference to the UPrompt main windows, and the application path.

##### Properties
Note: Almost all properties cannot be set from external sources and are available only to be read.

| Name                      | Type            | Default Value                   | Description                                              |
|---------------------------|-----------------|---------------------------------|----------------------------------------------------------|
| `LastWarning`             | `string`        | empty string                    | Holds the last warning message issued.                    |
| `WarningHistory`          | `List<string>`  | empty list                      | Keeps a history of all warning messages.                  |
| `LastError`               | `string`        | empty string                    | Contains the last error message issued.                   |
| `ErrorHistory`            | `List<string>`  | empty list                      | Maintains a list of all error messages.                   |
| `LastOutput`              | `string`        | empty string                    | Stores the last message issued.                           |
| `OutputHistory`           | `List<string>`  | empty list                      | Records the history of messages.                          |
| `Windows`                 | `Prompt`        | Reference to main windows       | Represents the main window of the application.            |
| `Application_Path`        | `string`        | Application path in web format | The application's folder path in a format that HTML could use. |
| `Application_Path_Windows`| `string`        | Application path in Windows format | The application's folder path in Windows format that Powershell and applications could use. |
| `UPrompt_exe`             | `string`        | UPrompt executable path         | The file path of the UPrompt.exe that is running.         |
| `Xml_Path`                | `string`        | Path to the current XML page   | The XML file path for the current page.                   |

##### Method
All methods that can be run have mandatory arguments.

| Name             | Arguments                                             | Return Value                 | Description                                                  |
|------------------|-------------------------------------------------------|------------------------------|--------------------------------------------------------------|
| `Output`         | **string** message, **string** title, MessageBoxButtons buttons, MessageBoxIcon icon  | DialogResult                 | Displays a message box if the production setting is false; otherwise, records the output.                               |
| `Warning`        | **string** message, **string** title, MessageBoxButtons buttons, MessageBoxIcon icon  | DialogResult                 | Shows a warning message box if the production setting is false; otherwise, logs the warning.                            |
| `Error`          | **string** message, **string** title, MessageBoxButtons buttons, MessageBoxIcon icon  | DialogResult                 | Presents an error message box if the production setting is false; otherwise, records the error.                         |
| `ShowVariable`   | string variableName, bool ShowDialog                   | Dictionary string,string    | Used by the ShowVariable action; refer to its documentation for usage details.                                            |
| `SetVariable`    | **string** variableName, **string** variableValue      | void                        | Used by the SetVariable action; refer to its documentation for usage instructions.                                        |
| `GetVariable`    | **string** variableName                              | string                       | Used by the GetVariable action; consult its documentation for how to use it.                                              |
| `DeleteVariable` | **string** variableName                              | void                         | Deletes a user variable completely; use with caution as it may crash the application or cause unintended issues.         |

#### UHandler
This contains all methods that run actions. The class represents Powershell and C# extensions, and most of it cannot be run or set from external sources, but it is available to read.

##### Class
There are 2 subclasses that define an instance of an extension when you configure settings in UPrompt for both Powershell or C# extensions. You can create a new instance of one of these classes. They contain their own methods and properties that allow them to keep running and interact with scripts or methods. They are public, so you can create your own instance of them in the same way you do when setting the constructor. The constructors are barely the same as the settings.
- ExtentionHandler
- PowershellHandler

##### Properties
| Name                   | Type                           | Default Value                    | Description                                         |
|------------------------|--------------------------------|----------------------------------|-----------------------------------------------------|
| `LastActionOutput`     | `string`                       | empty string                     | Holds the last action output issued.                 |
| `PowershellHandlers`   | `Collection<PowershellHandler>`| empty collection                 | Holds all the PowershellHandler instances created by UPrompt. |
| `ExtentionHandlers`    | `Collection<ExtentionHandler>` | empty collection                 | Holds all the ExtentionHandler instances created by UPrompt.    |

##### Method
| Name          | Arguments                                    | Return Value  | Description                                               |
|---------------|----------------------------------------------|---------------|-----------------------------------------------------------|
| `RunAction`   | **string** ActionName, **string** ActionArgument, string ActionId  | void   | It allows you to run actions as you would in a ViewAction. Refer to both the action and view sections to learn more.

#### UParser
This is a class that basically parses XML to HTML and handles the view. There are no accessible properties, and it contains some useful methods to generate your own HTML and refresh the view.

##### Method
| Name                    | Arguments                        | Return Value  | Description                                               |
|-------------------------|----------------------------------|---------------|-----------------------------------------------------------|
| `ReloadView`            | N/A                              | void          | It will simply reload the view from the actual XML and apply a refresh to the web page. |
| `GenerateHtmlFromXML`   | **string** Xml                   | string        | It will simply take the XML you pass to it and generate the associated HTML. |
| `ParseSettingsText`     | **string** Text                  | string        | It takes text and applies formatting for settings. For example, "#FONT#" will become "Arial" if the configured font is Arial. |
| `ParseSystemText`       | **string** Text                  | string        | It takes text and applies formatting for system and user variables. For example, "{USER}" will become "YourUserName" and [YourVariableName] will become "Your Variable Value". |

Here's the full Markdown with the tables and content included:

#### USettings
This class has all the properties and methods to view and set settings of UPrompt.

##### Properties
Here is a list of properties that represent a setting as they are declared in C#. You can see their default values. Note that all of them are only readable because to set a setting, you must use the method.

```csharp
 bool ShowSplash { get; private set; } = false;
 string Text_Color { get; private set; } = "#fff";
 string Background_Color { get; private set; } = "#22252e";
 string Accent_Color { get; private set; } = "#272c33";
 string Text_Accent_Color { get; private set; } = "#000000";
 string Fade_Background_Color { get; private set; } = "#000";
 string Fade_Accent_Color { get; private set; } = "#fff";
 string WindowsOpenMode { get; private set; } = "Normal";
 string WindowsResizeMode { get; private set; } = "All";
 bool ShowMinimize { get; private set; } = true;
 bool ShowMaximize { get; private set; } = true;
 bool ShowClose { get; private set; } = true;
 int Width { get; private set; } = 600;
 int Height { get; private set; } = 600;
 string Item_Margin { get; private set; } = "3%";
 string Font_Name { get; private set; } = "Arial";
 bool Production { get; private set; } = false;
 string Application_Name { get; private set; } = "UPrompt Demo";
 string Application_IconPath { get; private set; } = UCommon.Application_Path_Windows;
 Icon Application_Icon { get; private set; } = Properties.Resources.uicon;
```

##### Class
There are 2 subclasses that define what a setting is and a list of settings. They are used to easily use the Load method. For example, creating a list of settings and then just passing it to the method instead of calling the Load method multiple times for each setting.
- USetting
- USettingList

##### Method
| Name        | Arguments                           | Return Value | Description                                                    |
|-------------|-------------------------------------|--------------|----------------------------------------------------------------|
| `ReLoad`    | N/A                                 | void         | It will simply reload the settings from the actual loaded XML.  |
| `Load`      | See in C#, there are multiple overloads of it | string | It will simply set a setting that you pass to it using the USetting/USettingList class or by name/value instead. |
| `LoadXml`   | **string** Path, bool LoadSetting   | void         | It allows you to load a new XML page by specifying its path. You can or not load settings from it. |
